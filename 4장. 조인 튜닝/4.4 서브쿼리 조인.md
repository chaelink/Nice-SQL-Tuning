### 4.4 서브쿼리 조인

- 쿼리 변환 : 사용자로부터 전달받은 SQL을 최적화에 유리한 형태로 변환하는 작업
- 서브 쿼리 : 하나의 SQL문 안에 괄호로 묶은 별도의 쿼리 블록
  - 스칼라 서브쿼리 : select 절, 한 레코드 당 정확히 하나의 값을 반환
  - 인라인 뷰 : from 절
  - 중첩된 서브쿼리 : where 절
 

- 서브쿼리는 메인쿼리에 종속, 단독 실행 불가
- 메인쿼리 건수만큼 값을 받아 **반복 필터링**하는 방식으로 실행

---
#### nest(중첩된) 상태
**서브쿼리 Pushing**
- Unnesting 되지 않은, 즉 중첩된 상태에서만 사용 가능
- 서브쿼리 필터링을 가능한 앞 단계에서 수행하도록 강제 (no_unnest push_subq)
- 서브쿼리 필터링을 가능한 한 나중에 처리하려면 (no_unnest no_push_subq)


**필터 오퍼레이션**
- 서브쿼리를 풀어내지 않고, 필터방식으로 그대로 수행(NO_UNNEST)
- NL조인 처리방식과 동일, 부분범위 처리 가능
- NL조인과의 차이점
  - 캐싱 기능을 가짐
  - 조인 순서 고정, 메인쿼리가 항상 드라이빙 테이블임 

---
#### 4.4.3 unnest(풀어진) 상태
- 다양한 조인, 최적화 기법 사용 가능
- ROWNUM은 UNNESTING을 방해,무조건 중첩문 필터링

---

### 뷰(View)와 조인
- 뷰 머징
  - merge 힌트 : 뷰를 메인 쿼리와 머징 / 반대는 no_merge
  - 부분 범위 처리 불가능
- 조인 조건 Pushdown
  - 11g 이후부터 가능한 쿼리 변환 기능
  - 메인 쿼리를 실행하면서 조인 조건절 값을 건건이 뷰 안으로 밀어 넣는 기능
  - 힌트 : no_merge push_pred, 실행 계획 : view pushed predicate
  - 부분 범위 처리 가능

<br>

- 인라인 뷰 안에서 메인쿼리 테이블 컬럼을 참조하면 ORA-00904 에러 발생
- 오라클 12c부터, 인라인 뷰를 Lateral로 선언하면, 인라인 뷰 안에서 메인쿼리 컬럼 참조 가능
- 조인 조건 Pushdown 기능이 작동하지 않을 때 만 사용



---

### 스칼라 서브쿼리 조인
(1) 스칼라 서브쿼리의 특징
- 메인쿼리 레코드 마다 정확히 하나의 값만 반환
- 컨텍스트 스위칭 없이 메인쿼리와 서브쿼리를 한 몸체처럼 실행(재귀x)

(2) 스칼라 서브쿼리 캐싱
- 쿼리 단위로 이루어짐
- 조인 횟수 최소화를 위해 입력값과 출력값을 내부 캐시에 저장
- 필터 서브쿼리 캐싱과 같은 기능

(3) 스칼라 서브쿼리 캐싱 부작용
- 캐싱 비효율
  - 캐시 공간이 매우 작음 -> **입력 값의 종류가 소수여서 해시 충돌 가능성이 적어야 캐시 효과가 있음**
  - 메인쿼리 집합이 매우 작은 경우 -> 캐시 재사용성이 낮아 캐싱이 비효율

(4) 두 개 이상의 값 반환
- 두 개 이상의 값을 반환하면서 + 스칼라 서브쿼리의 부분함수 처리 기능을 사용하고 싶음
- => 구하는 값들을 문자열로 모두 결합하고, 바깥쪽 액세스 쿼리에서 substr 함수로 다시 분리하는 방식

(5) 스칼라 서브쿼리 Unnesting
- 대량 데이터를 처리하는 병렬 쿼리는 해시 조인으로 처리해야 효과적










